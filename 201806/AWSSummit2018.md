# AWS Summit 2018

## サイゲ

今日の発表はエンジニア向けではなく、全職種向けなのでふわっと説明する。  
エンジニアはIEEEカンファレンスで詳細聞いてくれ。

### ヘッドレスモード
ChromeとかFFについてるGUIを切った状態でブラウザをCUIで操作することができる機能
Unityでもヘッドレスなアプリをビルドするオプションがある

### ヘッドレスなゲームをサーバ上で実行させる利点
* 通常のゲームはユーザが近くできるように1フレームごとに処理を実行する必要があるが、  
ヘッドレスの場合GUIが無いので待つ処理をすべて取っ払って高速にテストすることができる

### QAチェックフロー
1. Jenkinsでビルド
2. EC2にデプロイ
3. Lambdaに通知
4. LambdaでQAチェックの処理走らせる
5. （うまくいったらS3に上げる）
6. SlackにQAチェック結果を通知

## マギレコ
個人的に今日の本命
社員数120人くらいでマギレコは2017.08リリース。ソシャゲとしては4作目。（5作目を仕込み中）

### マギレコのクライアント
* クエストはCocos2d-x
* それ以外はWebViewとCocos2d-x（バナーなどのUIはWebView）

### マギレコ以前のインフラ
* いままではオンプレ  
	* SEGAと業務提携してるのでSEGAのインフラエンジニアにお願いしてた  
* マギレコが初AWS  
	* Aurora使いたかったのが一番の理由で採用。ほかはクラウドのよくある理由。  

### マギレコの基本全体構成
* クライアント - AWS はHTTP2で通信
* KPI, 分析計のでーたはAWS - TreasureData
* メトリクス収集はAWS - Mackerel

### マギレコAWS構成
* Route53
* WAP
* CroudFront
* S3  
	* 動画や画像など静的なもの  
* EC2  
	* ALBあり, AutoScaling  
* DynamoDB
* Aurora  
	* シャーディングあり(ユーザIDを軸に8つ)  
	* シャーディングしないデータはDefault  
	* マスターとレプリカ用意  
* Lambda
* ElasticSearch  
	* ユーザを名前であいまい検索する要件があったのでこの辺いれてる  
	* サポート編成(うちとは違っていろんなユーザの中からランダムで出すよくあるやつをやるために使ってる)

#### バッチ
* Digdagの情報
* LogStash - Elasticsearch  
	* ユーザ情報を定期的にエクスポート  
	* Redshiftも使ってる  
* CloudWatch Logs - S3 - Athena  
	* 日毎のログを送ってる  
	* CloudWatch Alarmでメトリクス監視 -> メールでお知らせ

#### KPI周り
いったんTreasureDataのSDKから取れたデータをTreasureDataに送る  
そのあとにRedshiftやSupersetで分析可視化  
KPIが日毎更新しかできないのでリアルタイム更新になるようにがんばりたい

### AWSの管理
* ほぼすべてをTerraformで管理。CloudFormationで管理しようと思ったが見た瞬間心折れた
* 設定管理はAnsible  
	* JenkinsでAnsibleのコードをS3にアップロード  
	* EC2はイミュータブルにしてるので都度再作成（フラグかなんかで再作成するか決めてる）

### マギレコ開発体制
* 企画 8
* サーバ 3  
	* サーバ1 インフラ1ってどっちもできる人1って感じ
* クライアント 4
* フロント 2
* デザイナー 18
* シナリオライター 5
* プロデューサー 1

この体制でインフラをいじりはじめて約1年でリリース（開発いつからやったのかはわからん）
（この間にリリース延期の意思決定が正式リリース5ヶ月前に1回）
少ない人数でできた理由としてマネジメントサービスをフル活用, AWSの人をたくさん使った
ブラックベルトオンラインセミナーやった

## gumi
Less DevOps, More Code  
CTOが来た！最初から技術職やってたわけじゃなくgumiの前は漁業？とかやってたらしいｗｗｗ  
gumiはえりくさー, nodejs, python, PHP  
共通基盤がえりくさー, 最近はGoで書かれてる  
AWSは8年くらい使ってるのでAWSに自信ニキ  
今日の話はインフラエンジニア5人に対して監視対象が1200もあるけどどうやってんの？  
現場なんてどこの会社も問題だらけだしgumiもやばいけど工夫して頑張ってるよって話  

### 2010 - 2011年頃のgumi
* 初代CTOによりAWS以外をベースにしたインフラ構築すべて禁止
* AWS専任者任命
	* 業務量が増えるに連れて破綻
	* 一人でやるためドキュメントも更新されないがち

### 2012 -2013年頃のgumi
* 初代CTOがAWSに転職ｗｗｗｗｗ
* 初代専任者をベースにチーム結成
	* 共通基盤開発チームと運用チームを設立
* チーム開発による問題も発生
	* 属人化
	* 縦割りのチームが増えたのでコミュニケーションコストが高くなった
	* 構成ドリフトなども増加, 設定ぬけもれ多い
	* 進捗の遅れを残業でカバーするようになる → 人多いのに↑ の問題でなかなか終わらずて糞職場化した
	* 単純にチーム内で技術力の高い人をリーダーにするだけじゃだめ

### 2014 - 2016年頃のgumi
* プラベチャット禁止
	* 属人化の解消
* チケット管理徹底
* 管理者の承認徹底(勝手なプレイ禁止)
* ジョブローテーション
	* 手作業をコード化もし始める
	* サイロ化をふせぐ
* 管理者（リーダー？）の責任増加
	* 管理者がヒヤリングしたりして慎重に意思決定する, 手戻りが怖くなって難しいことを抱えがちになり管理者がボトルネックになる
	* メンバーは難しいこと、責任、権限が奪われてバカになってく（何でもかんでも管理者に聞かないとできない分かんないっていう）
	* 全容を知ってる管理者がドキュメントを更新しなくなる（してる暇が無くなるので物理的に無理）ので後続から見て環境最悪

### 2017 - 2018年頃
* インフラ運用者と開発者による合議
* 運用と開発でジョブロテしたり頑張ったけど現状維持で精一杯で頭打ちする場面もある
	* 社内外からエキスパート人材を招聘した
		* 招聘なのでエキスパート人材が最強に働きやすい環境を作って権限もかなり渡して不自由なく働いてもらえるようにした
	* 新生インフラチームができた
		* 手作業を徹底排除、コード化をお願い
* 旧環境の遺物との決別が大変
* コード化の弊害も無いわけじゃない
	* 難しい部分がジョブに隠蔽されてるので学習意欲の低い, スキルの低い人がチームに入った場合、  
	実際に行われてる作業の把握が遅いのでなにか問題があったときに対処できない

### ツール導入, コード化について
* ツールええやん導入！じゃなくて他社と自社のバックグラウンドとかいろいろ考えてから入れろとかとかって言ってた。たぶん普通にちゃんと考えて入れろってこと。
* 例えばgumiはpythonistaが多数在籍してるから近辺のツール選択しやすい
* CloudFormationなどを生で使ってない、コードで補ってる
	* 一時的にお試しでAWS環境にインスタンスを追加 -> 検証 -> 外すとかもコードでやってる（yaml？から設定入れたり取ったりデプロイしたり）
* AnsibleとCloudFormationを接着するコードを書いてる
	* そのまま使う？やめようオンプレ脳らしいｗ
	* 標準AMIをそのまま使う, Playbookでカスタマイズ

### まとめ
* 挑戦すると失敗もするので失敗から必ず学んでくれ（エモい感じのまとめでごめんって言ってた）
* インフラ運用してる人の評価は加点にしてくれ、減点だと守りに入ってガチガチの構成で挑戦をしなくなる、よくない

## FF15 ポケットエディション
やばい前半トレーナー業務してて何言ってたか聞いてなかった

### オンライン処理が必要になったよ
* 課金処理
* チャプター購入型なので購入処理など

### AWSに決めた理由
* 150カ国同時リリースなので負荷対策をきちんとしたい
* ヨコテンのため人数がすくない
* 機能としては小さいのでサーバレスにチャレンジしてみたかった

### 課金処理
* API Gateway
* Lambda
* DynamoDB

### ログ収集
データ集計や検索の他、DynamoDBになにか障害が起きたときのデータ復元用に利用
* Lambda -> Amazon Kinesis経由でAmazon S3に保存
	* 当時はDynamoDBにPoint-in-Time Recovery機能がなかったためこのようにしていた
	* 今から作るならPoint-in-Time Recovery前提で差分ログだけ保存するとかの工夫をすると思う
		* 差分ログ方式を取るならレコードを追加のみで更新削除されるようなテーブル設計にしない

ここから先は普通に資料公開するからそれ見てって言われたロビ

### DynamoDB
* Capacity Auto Scalingにお任せ
* 特定のPartition Keyにアクセス集中させない
* トランザクションなくて困ったときの代替手段
	* Transaction Library For DynamoDb（Java）
	* aurora
	* FF15 PEではトランザクションなしで行くことにした。TLA+という言語でなしで本当にいけるのか検証した
		* TLA+ is 何？　-> これでAWSの中の人が開発してるらしい

### Lambda
* Node.jsで開発
* AWS Cloud9が出る！
* 負荷テストのクライアントとして使う
	* JMeter Master / Slaveで最初やってたが、負荷のかかりが頭打ちしたときがあってLambdaにした
		* 結局JMeterの設定が良くなかっただけなんだけど、Lambdaも便利だった
* アセットバンドルダウンロードチェックもLambda使ってやった
	* 数多くてだるいしLambdaでばっとやった